# 牙齿根管口检测
## 一、题目描述
根管治疗是目前最有效、最常见的治疗牙髓病和根尖周病的方式，可以从根本消除牙齿内部炎症及其病变源，预防炎症加重扩散。

准确地定位每一个根管口是确保根管治疗手术成功的关键。若存在根管口遗漏的情况，将会导致根管预备不充分、根管充填不完全，从而增加治疗的失败风险，并严重影响治疗效果。临床统计显示，在已经进行根管治疗的后牙中，有 23.04%的牙齿存在根管遗漏的情况。同时，临床研究表明，治疗过程中遗漏根管的患牙，其术后根尖周病变的概率为未遗漏根管患牙的 4.38倍。因此，根管口检测具有非常重要的临床意义。

本次大作业需要你基于牙科医学中的根管口检测项目，使用 C++ 实现一个完整的图像处理系统。具体来说，你需要实现对牙齿图像的预处理、特定区域的分割和识别，并最终检测出根管口的位置。如果你了解过机器学习可能知道，这其实相当于一个目标检测任务，不过我们本次作业基础任务中不考虑模型训练，而是直接使用训练好的模型进行预测。

## 二、TODO
### 1. 基础任务
你的预测程序应当接受一张图像输入，检测到根管口的位置，用若干个矩形进行框定，在检测到的目标上绘制边界框，并输出标记好检测框的图像。具体来说，本次大作业主要分为以下几个子任务（详见下一部分）：

注意：

初始输入图像需要整体整形为(1272, 1080)

图像颜色通道顺序为RGB

① 图像预处理：从输入的牙齿图像定位牙髓室所在位置并截取ROI区域。（可调库实现）

② HOG特征提取：得到ROI区域，以ROI区域（保持为RGB色域）进行HOG特征向量提取。（需手动实现）

③ SVM加载与调用：使用SVM模型对这些特征向量进行划分，得到检测框。（可调库实现）

SVM（支持向量机）模型我们已经帮你训练好，可以直接使用。感兴趣的同学可以自行学习，了解其原理。

④ 非极大值抑制：如果存在若干重叠的检测框，根据一定规则进行筛选，并只保留一个。（需手动实现）

### 2. 进阶任务
对于本次作业的加分项，你可以考虑对视频进行检测。

具体来说，你应当首先抽取每一帧视频帧，将每帧图像转换为合适的格式（例如，灰度图像或其他预处理），在每帧中利用简单的追踪算法（如Kalman Filter）识别多个目标并进行跟踪，最后将处理后的视频保存为新文件（可以使用OpenCV的VideoWriter类）。

## 三、基础任务分解
### 1. 图像预处理
对于一幅牙齿图像，我们固然可以直接用于根管口检测，但由于根管口本身偏小，这样的检测效果可能不好——因此我们需要考虑使用某些方法提取牙齿主体。我们可以采用多种方式提取牙齿主体部分，以减少牙体外目标检测错误。这一部分需要你从输入的牙齿图像定位牙髓室所在位置并截取，相关算法你可以直接调库实现。具体来说分为两步：

实现牙齿区域提取：根据色域/形状信息对牙齿所在区域进行检测。

实现髓室底区域提取：根据亮度信息将牙齿的髓室底区域进行检测。

样例如下：（圆圈仅为参考，可以使用不同形状的表示方法，能正确表示检测区域即可）

下面给出了一些可行的方法， 你也可以自行探索其他办法：

OTSU+K-Means

思路：使用多层Otsu阈值法对图像进行分割，提取牙齿区域。使用K-Means算法对牙齿图像进行聚类分割，区分牙齿、背景等不同区域。

参考库：OpenCV自带单类Otsu分割（cv::threshold）与K-means函数OpenCV（cv::kmeans()）。

椭圆形牙体拟合

思路： 利用颜色信息检测牙齿轮廓，并进行椭圆拟合来估算牙齿的形状。检测牙齿轮廓涉及色彩空间转换和形态学操作，你可能需熟悉颜色阈值选择以及形态学操作的原理。

参考库： OpenCV（cv::findContours() 可以在图像中检测轮廓, cv::fitEllipse() 用于拟合椭圆）

### 2. HOG特征提取
在对图像成功进行预处理后，我们便可以提取图像特征。也许你对于使用卷积池化等可训练的方法提取特征的过程早有耳闻，但这里我们使用固定的特征提取方法。这一部分你需要手动实现HOG特征提取的步骤，包括梯度计算（可以考虑使用Sobel算子）、方向直方图构建、特征块标准化。

最终给出HOG特征提取以后的可视化特征图：在每个像素上给出梯度的方向以及的梯度的大小。

这里给出HOG特征的超参数：
```
window_size = (32,32)
block_size = (16,16)
cell_size = (8,8)
stride_size = (8,8)
num_bins = 9
```
### 3. SVM加载与调用
现在我们已经将图像转换为特征向量了，接下来就该轮到“数学”模型登场了！（事实上，传统的机器学习任务大多都是这个流程：先提取数据特征，后根据特征进行分类或其它任务）这一部分需要你使用提供的预训练SVM模型来对提取的特征进行分类。由于svm训练的向量是基于opencv官方库的HOG特征，因此在这里可以直接调用Opencv库进行hog特征提取库进行特征提取，也可以使用自己实现的hog特征提取函数进行提取。

参考库： OpenCV（cv::ml::SVM::load()）


### 4. 非极大值抑制（NMS）
现在你应当得到了一些检测框，但是如果你了解过目标检测任务可能知道，模型可能在一个位置附近产生多个检测框——这显然是不利于分类的（至少看起来乱七八糟的），因此这一部分需要你自行实现非极大值抑制算法，去除冗余检测框。

同时，由于SVM的性能不够强大，可能检测到不同位置的检测框，请你仔细观察根管口的位置分布，并结合步骤1、2的ROI区域，保留最可能是根管口的位置。

最后，你可以使用OpenCV提供的绘制函数（如cv2.rectangle）来显示检测结果。

## 四、数据集信息
请下载本次可能用到的数据文件：asset.zip

压缩包中包括以下文件：

310_svm_32.xml - SVM模型参数，直接导入使用即可。

310_svm_64_图片.xml - 用于图像检测的SVM模型参数，直接导入使用即可。

310_svm_64_视频.xml - 用于视频检测的SVM模型参数，直接导入使用即可。

310_svm_128.xml - SVM模型参数，直接导入使用即可。

三个模型参数对应不同规模的SVM，文件名中数字表示滑动窗口的大小，如32表示使用的是32*32大小的滑动窗口进行HOG特征提取训练的SVM。你可以自行选择合适的模型参数使用。

bg-310.rar - 一些牙齿图像数据，包括 24张离体牙的显微镜视角图像

注意：数据仅限于本次题目使用，不得在学习、训练之外使用。
